const mongoose = require('mongoose');
const Client = require('../models/schemas/client');
const Schemas = require('../models/schemas/timeSheet');
const TimeSheetSchema = Schemas.timeSheetSchema;


module.exports.createNewTimesheet = function(req, res, next) {
	return Client.findOne({
		mongoCollectionKey: req.headers['x-mongo-key'],
		clockInNumber: req.body.clockInNumber }, '_id', function(err, client) {
			console.log("Searching for Client with this clock-in number")
			console.log()
			return client
		}).exec().then((client) => { // Clear out any missed clockOuts
			const TimeSheet = mongoose.model('TimeSheet', TimeSheetSchema, req.headers['x-mongo-key'] + '_TimeSheets')
			TimeSheet.findOneAndUpdate({user: client._id, status: "Clocked In"}, {timeOut: Date.now(), status: "Clocked Out" }, { new: true }, function(err, updatedMissedTimeSheet) {
				if (!updatedMissedTimeSheet) return console.log("No missed clock-outs to update")
				console.log("Missed Clock-Out Updated - Logged")
				console.log(updatedMissedTimeSheet)
				return updatedMissedTimeSheet
				if (err) next(err)
			}).then((client, updatedMissedTimeSheet) => {
			const TimeSheet = mongoose.model('TimeSheet', TimeSheetSchema, req.headers['x-mongo-key'] + '_TimeSheets')
			console.log("Creating Fresh Clock-In")
			data = {
				user: client._id,
				name: client.firstName,
				timeIn: Date.now(),
				status: "Clocked In"
			}
			const newTimeSheet = new TimeSheet(data);
			newTimeSheet.save(function(err, timeSheet) {
				if (err) return next(err)
				res.send(timeSheet);
				console.log("New Clock-In TimeSheet Created: ")
				console.log(timeSheet);
			}).catch(err => console.log(err))
		})
	})
}
